<?PHP/** * Simpla CMS * * @copyright 	2011 Denis Pikusov * @link 		http://simplacms.ru * @author 		Denis Pikusov * * Этот класс использует шаблон page.tpl * */require_once('View.php');use Zend\Http\Request;class TopicView extends View{    public function fetch()    {        $id = $this->request->get('id');        $topic_model = $this->communitys->Topic();        $vote_model = $this->communitys->Vote();        $topic = $topic_model->getTopic(['id'=>$id]);        if(empty($this->user->id) || empty($topic))            return false;        //votes        $topic->is_vote = $vote_model->is_vote(['topic_id'=>$id, 'user_id'=>$this->user->id]);        $vote = new stdClass();        $vote->vote_for = $vote_model->count_vote(['topic_id'=>$id, "type"=>2]);        $vote->vote_hold = $vote_model->count_vote(['topic_id'=>$id, "type"=>1]);        $vote->vote_yes = $vote_model->count_vote(['topic_id'=>$id, "type"=>0]);        $this->design->assign('vote', $vote);        //empty timer        $today = date("Y-m-d H:i:s");        $topic->timer =(strtotime($topic->end_date)>strtotime($today));        //список фвйлов       $topic->files = $topic_model->get_files($id);        $topic->rules = $topic_model->get_rules($this->user->id);        $this->design->assign('topic', $topic);        $this->design->assign('page', $topic);        $users_topic = $topic_model->get_comments_users(['topic_id'=>$id]);        $this->design->assign('users_topic', $users_topic);        //console_log($users_topic);        $comments = $topic_model->tree_comments(['topic_id'=>$id]);        $this->design->assign('comments', $comments);        // Отображать скрытые страницы только админу        if(empty($topic) || (!$topic && empty($_SESSION['admin'])))            return false;        return $this->design->fetch('topic.tpl');    }    public function addAction()    {        // Отображать скрытые страницы только админу        if(empty($this->user))        {            header('Location: '.$this->config->root_url.'/user/login');            exit();        }        $id = $this->request->get('id', 'integer');        $community = $this->communitys->get_community((int) $id);        $this->design->assign('community', $community);        if(isset($_POST['topic'])) {            $name = $this->request->post('name');            $text = $this->request->post('text');            if (empty($name)) {                $this->design->assign('error', 'empty_name');            } elseif (empty($text)) {                $this->design->assign('error', 'empty_text');            } else {                $topic_model = $this->communitys->Topic();                $topic_id = $topic_model->add_topic(['community_id' => $id, 'user_id' => $this->user->id, 'name' => $name, 'text' => $text, 'visible' => true]);                $topic_model->add_files($topic_id);                 // Перенаправляем на страницу заказа                header('Location: '.$this->config->root_url.'/topic/'.$topic_id);            }        }            // Отображать скрытые страницы только админу        /*if(empty($topic) || (!$topic && empty($_SESSION['admin'])))            return false;*/        return $this->design->fetch('topic/add.tpl');    }    public function editAction()    {        // Отображать скрытые страницы только админу        if(empty($this->user))        {            header('Location: '.$this->config->root_url.'/user/login');            exit();        }        $id = $this->request->get('id', 'integer');        $topic_model = $this->communitys->Topic();        $topic = $topic_model->getTopic(['id'=>$id]);        //список фвйлов        $topic->files = $topic_model->get_files($id);        if(isset($_POST['topic'])) {            $name = $this->request->post('name');            $text = $this->request->post('text');            if (empty($name)) {                $this->design->assign('error', 'empty_name');            } elseif (empty($text)) {                $this->design->assign('error', 'empty_text');            } else {                $topic_id = $topic_model->update_topic($id, ['user_id' => $this->user->id, 'name' => $name, 'text' => $text, 'visible' => true]);                $topic_model->add_files($topic_id);                // Перенаправляем на страницу заказа                header('Location: ' . $this->config->root_url . '/topic/' . $topic_id);            }        }        $this->design->assign('topic', $topic);        $this->design->assign('page', $topic);        return $this->design->fetch('topic/edit.tpl');    }    public function aditComentAction()    {    }    public function add_vote()    {        $filter['topic_id'] = $this->request->get('topic_id');        $filter['user_id'] = $this->user->id;        $vote_model = $this->communitys->Vote();        if(empty($this->user->id) || empty($filter['topic_id']) || empty($vote_model->is_vote($filter)))            return false;        return true;    }}