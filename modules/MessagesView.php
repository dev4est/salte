<?PHP/** * Simpla CMS * * @copyright 	2011 Denis Pikusov * @link 		http://simplacms.ru * @author 		Denis Pikusov * * Этот класс использует шаблон page.tpl * */require_once('View.php');class MessagesView extends View{    function fetch()    {        $filter['subject_id'] = $id = $this->request->get('id', 'integer');        $messages = $this->messages->get_massage($filter);        $this->design->assign('messages', $messages);        $this->design->assign('messages_id', $messages[count($messages)-1]->id);        $filter['user_id'] = $this->user->id;        $items= $this->users->get_messages($filter);        $this->design->assign('items', $items);        /*Subject*/        $subject = $this->messages->get_subject($id);        $this->design->assign('subject', $subject);        /*get users*/        $users = $this->messages->get_users($id);        $this->design->assign('users', $users);        $this->design->assign('left_bar', 'messages/item_block.tpl');        $this->design->assign('page_name', $subject->text);        $body = $this->design->fetch('messages/message.tpl');        return $body;    }    public function createAction()    {        return $this->design->fetch('messages/create.tpl');    }    public function addAction()    {        $subject_id = $this->request->post('id', 'integer');        $text = $this->request->post('text');        $result = $this->messages->add_message(['subject_id'=>$subject_id,            "author"=>$this->user->username.' '.$this->user->surname,            'text'=>$text,            'user_id'=>$this->user->id]);        $this->design->assign('wrapper', 'ajax.tpl');        return $this->ajax->result_json($result);    }    public function loadAction()    {        $filter['subject_id'] = $this->request->post('id', 'integer');        $filter['id'] = $this->request->post('last', 'integer');        $result['id'] = $filter['id'];        $messages = $this->messages->get_massage($filter);        if(count($messages)>0)        {            $this->design->assign('messages', $messages);            $this->design->assign('wrapper', 'ajax.tpl');            $result['text'] = $this->design->fetch('messages/item.tpl');            $result['id'] =$messages[count($messages)-1]->id;        }        return $this->ajax->result_json($result);    }}