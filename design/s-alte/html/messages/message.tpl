{$page_name = 'qwdwqd' scope=parent}<div class="panel panel-flat">    <div class="panel-heading">        <a href="#" class="media-left">            {if $subject->image}                <img src="files/community/{$subject->image}" class="img-circle img-lg" alt="">            {else}                <span class="btn bg-teal-400 btn-rounded btn-icon btn-xlg"> <span class="letter-icon">A</span> </span>            {/if}        </a>        <div class="media-body">            <h6 class="media-heading">{$subject->text}</h6>            <a href="#" class="heading-text"><i class="icon-arrow-left22"></i> Назад</a>        </div>        <div class="heading-elements">            <span class="label bg-success heading-text">{$users|count} active</span>            <ul class="icons-list">                <li><a href="#" data-toggle="modal" data-target="#modal_small"><i class="icon-users4"></i></a></li>            </ul>            {include file="messages/user_modal.tpl"}        </div>        <div class="heading-elements">            <ul class="list-inline list-inline-condensed no-margin">                <!--<li><span class="btn bg-teal-400 btn-xs">+26</span></li>-->            </ul>        </div>    </div>    <hr style="margin: 0;">    <div class="panel-body">        <ul class="media-list chat-stacked content-group chat">            {*<li class="media date-step content-divider text-muted">                <span>New messages</span>            </li>*}            {foreach $messages as $m}                <li class="media">                    <div class="media-left">                        {if $m->image}                            <img src="files/profile/users/{$m->user_id}/{$m->image}" class="img-sm img-circle" alt="">                        {else}                            <img src="design/{$settings->theme|escape}/assets/images/placeholder.jpg"                                 class="img-circle img-md" alt="">                        {/if}                    </div>                    <div class="media-body">                        <div class="media-heading">                            <a href="#" class="text-semibold">{$m->author}</a>                            <span class="media-annotation pull-right">{$m->create_data} <a href="#"><i                                            class="icon-alarm position-right text-muted"></i></a></span>                        </div>                        {$m->text}                    </div>                </li>            {/foreach}           {* <li class="media">                <div class="media-left"><img src="design/{$settings->theme|escape}/assets/images/placeholder.jpg" class="img-circle img-md" alt="">                </div>                <div class="media-body media-middle">                    <i class="icon-menu"></i>                </div>            </li>*}        </ul>        <form id="messages_form" method="post">        <textarea name="message" class="form-control content-group" rows="3" cols="1" id="message"                  placeholder="Enter your message..."></textarea>        <div class="row">            <div class="col-xs-6">                <ul class="icons-list icons-list-extended mt-10">                    <li><a href="#" data-popup="tooltip" title="" data-container="body"                           data-original-title="Send photo"><i class="icon-file-picture"></i></a></li>                    <li><a href="#" data-popup="tooltip" title="" data-container="body"                           data-original-title="Send video"><i class="icon-file-video"></i></a></li>                    <li><a href="#" data-popup="tooltip" title="" data-container="body" data-original-title="Send file"><i                                    class="icon-file-plus"></i></a></li>                </ul>                <input type="file" id="multiFiles" name="files[]" multiple="multiple"/>            </div>            <div class="col-xs-6 text-right">                <button type="submit" class="btn btn-info btn-labeled-right">Відправити <b><i                                class="icon-circle-right2"></i></b></button>            </div>        </form>        </div>    </div></div>{literal}<!-- Сам код нашего чата --><script type="text/javascript">    $(document).ready(function () {        $(".chat").scrollTop($(".chat").get(0).scrollHeight);        $("#messages_form").submit(Send); // вешаем на форму с именем и сообщением событие которое срабатывает когда нажата кнопка "Отправить" или "Enter"        $("#pac_text").focus(); // по поле ввода сообщения ставим фокус         setInterval("Load();", 4000); // создаём таймер который будет вызывать загрузку сообщений каждые 2 секунды (2000 миллисекунд)    });    var last_message_id = {/literal}{$messages_id}{literal}; // номер последнего сообщения, что получил пользователь    var load_in_process = false; // можем ли мы выполнять сейчас загрузку сообщений. Сначала стоит false, что значит - да, можем    // Функция для отправки сообщения    function Send() {        // Выполняем запрос к серверу с помощью jquery ajax: $.post(адрес, {параметры запроса}, функция которая вызывается по завершению запроса)        $.post("/messages/add",            {                id:{/literal}{$subject->id}{literal},                text: $("#message").val() //  сам текст сообщения            },            function (result) {               console.log(result);               // last_message_id = result;                load();            }); // по завершению отправки вызываем функцию загрузки новых сообщений Load()        $("#message").val(""); // очистим поле ввода сообщения        $("#message").focus(); // и поставим на него фокус        return false; // очень важно из Send() вернуть false. Если этого не сделать то произойдёт отправка нашей формы, те страница перезагрузится    }    // Функция для загрузки сообщений    function Load() {        // Проверяем можем ли мы загружать сообщения. Это сделано для того, чтобы мы не начали загрузку заново, если старая загрузка ещё не закончилась.        if (!load_in_process) {            load_in_process = true; // загрузка началась            // отсылаем запрос серверу, который вернёт нам javascript            $.post("/messages/load",                {                    id: {/literal}{$subject->id}{literal}, // указываем на то что это загрузка сообщений                    last: last_message_id, // передаём номер последнего сообщения который получил пользователь в прошлую загрузку                    rand: (new Date()).getTime()                },                function (result) { // в эту функцию в качестве параметра передаётся javascript код, который мы должны выполнить                    $(".chat").append(result.text);                    console.log(result.id);                    if(last_message_id != result.id){                        last_message_id = result.id;                        if(result.id>0){                            $(".chat").scrollTop($(".chat").get(0).scrollHeight);                        }                    }                     // прокручиваем сообщения вниз                    load_in_process = false; // говорим что загрузка закончилась, можем теперь начать новую загрузку                });        }    }    $(document).ready(function (e) {        $('#messages_form').on('submit', function () {            var form_data = new FormData();            var ins = document.getElementById('multiFiles').files.length;            for (var x = 0; x < ins; x++) {                form_data.append("files[]", document.getElementById('multiFiles').files[x]);            }            $.ajax({                url: 'uploads.php', // point to server-side PHP script                dataType: 'text', // what to expect back from the PHP script                cache: false,                contentType: false,                processData: false,                data: form_data,                type: 'post',                success: function (response) {                    $('#msg').html(response); // display success response from the PHP script                },                error: function (response) {                    $('#msg').html(response); // display error response from the PHP script                }            });        });    });</script>{/literal}